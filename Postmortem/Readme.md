**Postmortem: –ò–Ω—Ü–∏–¥–µ–Ω—Ç —Å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ELMA365 Prod, Test, Dev**

---

### üïí –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞

- **08.04.2025 05:58** ‚Äî –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ELMA365.
- **08.04.2025 07:51** ‚Äî –°–æ–æ–±—â–µ–Ω–æ, —á—Ç–æ ELMA365 –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.
- **08.04.2025 07:55** ‚Äî –ü–æ–ª—É—á–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, —á—Ç–æ –≤—Å–µ —Ç—Ä–∏ —Å—Ç–µ–Ω–¥–∞ ELMA365 –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç.
- **08.04.2025 07:58** ‚Äî –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: –ø—Ä–∏—á–∏–Ω–∞ ‚Äî –≥–∏–ø–µ—Ä–≤–∏–∑–æ—Ä Hyper-V, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Ä–∞–∑–º–µ—â–µ–Ω—ã –≤—Å–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã ELMA365 Prod,Test,Dev.
- **08.04.2025 09:26** ‚Äî –ò–Ω–∂–µ–Ω–µ—Ä—É –ø–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ELMA365 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- **08.04.2025 09:30** ‚Äî –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä ELMA-MNG01 (—Å –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º VM) –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
- **08.04.2025 09:50** ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –≥–∏–ø–µ—Ä–≤–∏–∑–æ—Ä—É. –ò–Ω–∂–µ–Ω–µ—Ä –±—ã–ª —É–≤–µ–¥–æ–º–ª–µ–Ω.
- **08.04.2025 10:13** ‚Äî kube-apiserver –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –∫—Ä–µ—à –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.
- **08.04.2025 10:18** ‚Äî kube-apiserver –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ ETCD.
- **08.04.2025 10:25** ‚Äî –≠–∫–∑–µ–º–ø–ª—è—Ä ETCD –Ω–µ —á–∏—Ç–∞–µ—Ç –±–∞–∑—É, —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω.
- **08.04.2025 10:30** ‚Äî –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö VM: PostgreSQL, Mongo, S3.
- **08.04.2025 10:50** ‚Äî –£—Ç–æ—á–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ Deckhouse, –ø–æ–ø—ã—Ç–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞ ETCD.
- **08.04.2025 11:50** ‚Äî ETCD –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ.
- **08.04.2025 12:05** ‚Äî kube-apiserver –æ—Ç–≤–µ—á–∞–µ—Ç.
- **08.04.2025 12:15** ‚Äî –í—Å–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–æ–¥—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.
- **08.04.2025 12:20** ‚Äî –í namespace elma365-prod –æ—Ç–º–µ—á–µ–Ω—ã —Å–æ—Ç–Ω–∏ –∫—Ä–µ—à–µ–π –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç–æ–≤.
- **08.04.2025 12:35** ‚Äî –ü–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è ETCD Kubernetes —Å—á–∏—Ç–∞–µ—Ç, —á—Ç–æ –ø–æ–¥—ã –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –∏ —Å–æ–∑–¥–∞–µ—Ç –∏—Ö –∑–∞–Ω–æ–≤–æ, –ø–æ–ª—É—á–∞—é—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç—ã.
- **08.04.2025 12:45** ‚Äî `kubectl rollout restart deploy` –≤ elma365-prod —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ –¥–∞–µ—Ç.
- **08.04.2025 12:55** ‚Äî –ó–∞–ø—É—â–µ–Ω Helm-red–µ–ø–ª–æ–π:
```bash
helm upgrade --install elma365 elma365/elma365 --version 2024.11.28 \
  -f values-elma365.yaml --timeout=30m --wait -n elma365-prod --create-namespace --debug
```
- **08.04.2025 13:25** ‚Äî Red–µ–ø–ª–æ–π –Ω–µ —Ä–µ—à–∏–ª –ø—Ä–æ–±–ª–µ–º—É. –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–¥–æ–≤:
```bash
helm uninstall elma365 -n elma365-prod
helm uninstall elma365-dbs -n elma365-dbs
```
- **08.04.2025 13:35** ‚Äî –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ë–î:
```bash
helm upgrade --install elma365-dbs elma365/elma365-dbs -f values-elma365-dbs.yaml -n elma365-dbs --create-namespace
helm upgrade --install elma365 elma365/elma365 --version 2024.11.28 \
  -f values-elma365.yaml --timeout=30m --wait -n elma365-prod --create-namespace --debug
```
- **08.04.2025 14:10** ‚Äî –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ ELMA365-prod.
- **08.04.2025 15:30** ‚Äî –ù–∞–ø–∏—Å–∞–Ω–∏–µ Postmortem.
- **08.04.2025 16:00** ‚Äî –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è Dev –∏ Test —Å—Ä–µ–¥—ã.
- **08.04.2025 17:45** ‚Äî ETCD –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –≤—ã—è—Å–Ω–∏–ª–æ—Å—å: –≤ Test –∏ Dev, –ø–æ–º–∏–º–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–≥–æ ETCD, –±—ã–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
- **08.04.2025 17:50** ‚Äî –î–∞–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –±—ã—Å—Ç—Ä–µ–µ –ø–æ–¥–Ω—è—Ç—å Dev –∏ Test –∏–∑ –±—ç–∫–∞–ø–∞ —Å–∞–º–∏—Ö VM.

---

### üö® –ü—Ä–∏—á–∏–Ω–∞
–§–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å RAID-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –Ω–∞ –≥–∏–ø–µ—Ä–≤–∏–∑–æ—Ä–µ Hyper-V –ø—Ä–∏–≤–µ–ª–∞ –∫ –ø–æ—Ç–µ—Ä–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω:

- Kubernetes (Prod, Test, Dev ‚Äî –≤—Å–µ single-node)
- PostgreSQL - Prod
- MongoDB - Prod
- S3 —Ö—Ä–∞–Ω–∏–ª–∏—â–µ - Prod

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å—Ä–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ETCD, –∏–∑-–∑–∞ —á–µ–≥–æ `kube-apiserver` –∫—Ä–∞—à–∏–ª—Å—è. 
–ü–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ETCD –∏–∑ backup —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–æ–¥—ã –ø–æ–¥–Ω—è–ª–∏—Å—å, –Ω–æ Kubernetes –ø–æ–≤—Ç–æ—Ä–Ω–æ —Å–æ–∑–¥–∞–ª –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–¥–æ–≤, –≤—ã–∑–≤–∞–≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.

---

###  –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –≥–∏–ø–µ—Ä–≤–∏–∑–æ—Ä—É
- –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å MongoDB, PostgreSQL, Redis, RabbitMQ, S3
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã ETCD –∏ `kube-apiserver`
- –û—á–∏—Å—Ç–∫–∞ namespace-–æ–≤, `helm uninstall`
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞  Elma365 —á–µ—Ä–µ–∑ `helm chart` –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ë–î: `elma365-dbs`, `elma365`

---

### üìå –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è      | –î–µ–π—Å—Ç–≤–∏–µ                                                                 |
|----------------|--------------------------------------------------------------------------|
| –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ | –î–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–¥–æ–±–Ω—ã—Ö —Å–±–æ–µ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –≥–∏–ø–µ—Ä–≤–∏–∑–æ—Ä–∞–º |

---

###  –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ ETCD
```bash
crictl ps -a | grep etcd
abf441d87d0eb       3496ce9ae3406       About a minute ago   Exited              etcd                                      100                 27d6b85f2e6cd       etcd-elma-test01
26f3df04ef3f0       e8c7c7a6901a9       14 hours ago         Exited              backup                                    0                   f7bcb0248130e       d8-etcd-backup-b5f5aba8a10bdd6e37805598d89823389-29067840-678zn
c487426544453       3496ce9ae3406       6 days ago           Exited              image-holder-etcd                         0                   e02fbe03c6f09       d8-control-plane-manager-fgghs
crictl logs abf441d87d0eb
```
–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
```bash
abf441d87d0eb  etcd  Exited  "failed to find database snapshot file (snap: snapshot file doesn't exist)"
```

–û—à–∏–±–∫–∞
etcd –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ snapshot-—Ñ–∞–π–ª v3-–±–∞–∑—ã:
```bash
/var/lib/etcd/member/snap/0000000006bb8132.snap.db
```
–ò–∑-–∑–∞ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç panic –∏ crash:
```bash
panic: failed to recover v3 backend from snapshot
```

---


# –ß–µ–∫–ª–∏—Å—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ETCD
–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes –Ω–∞ –±–∞–∑–µ Deckhouse –ø–æ—Å–ª–µ —Å–±–æ—è ETCD, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º kubectl –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, 
–∞ static pods –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è kubelet. 
–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ control-plane —á–µ—Ä–µ–∑ crictl, etcdctl, crane, journalctl.

#### –ù–µ–º–Ω–æ–≥–æ –æ—Ñ—Ç–æ–ø –ø—Ä–æ –ª–æ–≥–∏–∫—É
–ü–æ—Å–ª–µ —Å–±–æ—è ETCD 

‚Äî etcd ‚Äî —ç—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö, –≥–¥–µ Kubernetes —Ö—Ä–∞–Ω–∏—Ç –≤—Å—ë: –∫–ª–∞—Å—Ç–µ—Ä—ã, –ø–æ–¥—ã, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, —Å–µ–∫—Ä–µ—Ç—ã –∏ —Ç.–ø.

–ï—Å–ª–∏ etcd –ª–æ–º–∞–µ—Ç—Å—è (—É–¥–∞–ª—ë–Ω, –ø–æ–≤—Ä–µ–∂–¥—ë–Ω, –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω) ‚Äî –≤—Å—è –ª–æ–≥–∏–∫–∞ Kubernetes "–∑–∞–º–∏—Ä–∞–µ—Ç",
—Ç.–∫. –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –Ω–µ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.


–ü—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º kubectl –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
‚Äî kubectl ‚Äî —ç—Ç–æ CLI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Kubernetes, –Ω–æ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API-—Å–µ—Ä–≤–µ—Ä–∞ (kube-apiserver).

–ê API-—Å–µ—Ä–≤–µ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç etcd, —Ç.–∫. –æ–Ω –±–µ–∑ –Ω–µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã.


üëâ –ü–æ—ç—Ç–æ–º—É, –µ—Å–ª–∏ etcd —Å–ª–æ–º–∞–Ω, kubectl —Ç–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø, —Ç–∞–∫ –∫–∞–∫ –∫–ª–∞—Å—Ç–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –µ–≥–æ –∑–∞–ø—Ä–æ—Å—ã.

"–∞ static pods –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è kubelet"
‚Äî –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç.


–í Kubernetes –µ—Å—Ç—å static pods ‚Äî —ç—Ç–æ –ø–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –Ω–µ —á–µ—Ä–µ–∑ API-—Å–µ—Ä–≤–µ—Ä, –∞ –Ω–∞–ø—Ä—è–º—É—é kubelet-–æ–º, –ø–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º YAML-—Ñ–∞–π–ª–∞–º, 
—Ö—Ä–∞–Ω—è—â–∏–º—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–æ–±—ã—á–Ω–æ –≤ /etc/kubernetes/manifests).


kubelet (–ª–æ–∫–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç –Ω–∞ –∫–∞–∂–¥–æ–º —É–∑–ª–µ) –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –Ω–∞–ø—Ä—è–º—É—é –æ—Ç etcd ‚Äî –æ–Ω —á–∏—Ç–∞–µ—Ç YAML-—Ñ–∞–π–ª—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –¥–∞–∂–µ –µ—Å–ª–∏ –≤–µ—Å—å –∫–ª–∞—Å—Ç–µ—Ä "–ª–µ–∂–∏—Ç".

### Download and install etcdctl for server Kubernetes
```bash
curl -L https://github.com/etcd-io/etcd/releases/download/v3.5.17/etcd-v3.5.17-linux-amd64.tar.gz -o etcd.tar.gz
tar -xzf etcd.tar.gz --strip-components=1 etcd-v3.5.17-linux-amd64/etcdctl
cp /root/deckhouse/recovery-etcd/etcdctl /usr/local/bin/
chmod +x /usr/local/bin/etcdctl
which etcdctl
etcdctl version
```

### 1. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–∑–ª–∞
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è kubelet –∏ –Ω–∞–ª–∏—á–∏—è static pod'–æ–≤:
```bash
systemctl status kubelet
journalctl -u kubelet -f
journalctl -u kubelet -xe | grep etcd
ls -l /etc/kubernetes/manifests/
```
### 2. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è control-plane –±–µ–∑ kubectl
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –ª–æ–≥–æ–≤ ETCD, apiserver, Deckhouse:
```bash
crictl ps -a | grep kube-apiserver
crictl logs <APISERVER_CONTAINER_ID>
crictl ps -a | grep etcd
crictl logs <ETCD_CONTAINER_ID>
crictl ps -a | grep deckhouse
crictl logs <DECKHOUSE_CONTAINER_ID>
crictl images | grep deckhouse
crictl inspect <CONTAINER_ID> | grep imageRef
```
### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π etcd
–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è snapshot –∏ –∞—Ä—Ö–∏–≤–∞, –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ etcd:
```bash
ls -lh /var/backups/etcd/
ls -lh /var/lib/etcd/etcd-backup.tar.gz
tar -xzf /var/lib/etcd/etcd-backup.tar.gz
mv /etc/kubernetes/manifests/etcd.yaml /root/deckhouse/recovery-etcdcli/etcd.yaml
cp -r /var/lib/etcd/member /var/lib/deckhouse-etcd-backup
rm -rf /var/lib/etcd/member
ls -lh ~/etcd-backup.snapshot
```
### 4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ etcd –∏–∑ snapshot
```bash
ETCDCTL_API=3 etcdctl snapshot restore /root/recovery-etcdcli/etcd-backup.snapshot \
  --name elma-prod01 \
  --initial-cluster elma-prod01=https://192.168.175.12:2380 \
  --initial-advertise-peer-urls https://192.168.175.12:2380 \
  --data-dir /var/lib/etcd
```
### 5. –í–æ–∑–≤—Ä–∞—Ç etcd –≤ kubelet –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞
–í–æ–∑–≤—Ä–∞—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã:
```bash
cp /root/deckhouse/recovery-etcdcli/etcd.yaml /etc/kubernetes/manifests/etcd.yaml
systemctl restart kubelet
crictl ps | grep etcd
crictl logs -f $(crictl ps | grep etcd | awk '{print $1}')
```
### 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ ETCD –∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è etcd –∏ API:
```bash
ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key endpoint health
  ```
  –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å pod'–æ–≤
  ```bash
kubectl get po -A
 ```


### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- –û—Ç–∫–ª—é—á–∏—Ç—å etcd –∏–∑ –∑–∞–ø—É—Å–∫–∞ (mv etcd.yaml)
- –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å snapshot –∏ –æ—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ /var/lib/etcd
- –í—ã–ø–æ–ª–Ω–∏—Ç—å etcdctl snapshot restore
- –í–µ—Ä–Ω—É—Ç—å etcd.yaml –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å kubelet
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —á–µ—Ä–µ–∑ crictl logs, —É–±–µ–¥–∏—Ç—å—Å—è –≤ –∑–¥–æ—Ä–æ–≤—å–µ etcd
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å kubectl, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å pod'–æ–≤

