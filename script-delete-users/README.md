# Скрипт удаления пользователей в Elma365 из PostgreSQL и MongoDB
## Оглавление
1. [Описание](#описание)
2. [Настройки](#настройки)
   - [Внешнее или внутреннее подключение](#внешнее-или-внутреннее-подключение)
   - [Строки подключения](#строки-подключения)
   - [Исключаемые группы](#исключаемые-группы)
3. [Использование](#использование)
   - [Шаг 1: Подготовка списка пользователей для удаления](#шаг-1-подготовка-списка-пользователей-для-удаления)
   - [Шаг 2: Удаление пользователей](#шаг-2-удаление-пользователей)
4. [Пример запуска](#пример-запуска)
5. [Лицензия](#лицензия)

## Описание
Этот Bash-скрипт выполняет **двухэтапное удаление пользователей** из **PostgreSQL** и **MongoDB**, предварительно очищая групповые связи.

## Настройки

### Внешнее или внутреннее подключение
Скрипт может использовать **внешние** или **внутренние** соединения.

```sh
POSTGRES_ON_SEPARATE_SERVER="False"  # False -> подключение через kubectl exec
MONGO_ON_SEPARATE_SERVER="False"     # False -> подключение через kubectl exec
```

- `"True"` — используется **внешнее** соединение.
- `"False"` — используется **внутреннее** (Kubernetes `kubectl exec`).

### Строки подключения

#### PostgreSQL
```sh
PG_CONN_EXTERNAL="postgresql://elma365:Pass@192.168.1.21:5432/elma365?sslmode=disable"
```

#### MongoDB
```sh
MONGO_CONN_EXTERNAL="mongodb://elma365:Pass@192.168.1.22:27017/elma365?ssl=false"
```

### Исключаемые группы
Можно задать список групп, которые **не будут удаляться**.  
Разделяйте несколько групп точкой с запятой (`;`).

```sh
EXCLUDED_GROUPS="Все пользователи"
```


## Использование

### Шаг 1: Подготовка списка пользователей для удаления
Перед удалением создаётся список пользователей, которых **нужно** удалить (исключая пользователей из входного файла).

#### Команда:
```sh
./users_check_delete_v03.sh prepare users.csv
```
#### Входные данные:
- `users.csv` — Файл со списком email-адресов пользователей, которых **не следует** удалять.

#### Результат:
- Создаётся файл `users-delete_YYYYmmdd_HHMMSS.CSV`, содержащий:
  - Email пользователя
  - MongoDB ID (если есть)
  - PostgreSQL ID
  - Группы пользователя (исключая заданные группы)

#### Необходимо проверить:
- **Вручную** проверить файл `users-delete_YYYYmmdd_HHMMSS.CSV` перед удалением.

### Шаг 2: Удаление пользователей
После проверки списка запускаем удаление.

#### Команда:
```sh
./users_check_delete_v03.sh delete users-delete_YYYYmmdd_HHMMSS.CSV
```

#### Процесс:
1. **Удаляются групповые связи** (за исключением указанных в списке исключений).
2. **Удаляются пользователи** из PostgreSQL и MongoDB.
3. Создаётся **файл лога** `delete_log_YYYYmmdd_HHMMSS.log`.

## Пример запуска
```sh
./users_check_delete_v03.sh prepare exclude_users.csv
./users_check_delete_v03.sh delete users-delete_YYYYmmdd_HHMMSS.CSV
```

## Лицензия
Скрипт распространяется под лицензией MIT.
